[{"name":"App.R","content":"library(shiny)\nlibrary(ggplot2)\n\n# --- GLOBALE KONFIGURATION ---\ncuts_vdec <- seq(0, 60, by = 10)\ncustom_colors <- c(\"#1a9850\", \"#91cf60\", \"#d9ef8b\", \"#fee08b\", \"#fc8d59\", \"#d82027\")\n\n# ==============================================================================\n# MODUL UI DEFINITION (Das Layout für EINEN Athleten)\n# ==============================================================================\nathleteUI <- function(id) {\n  # ns (namespace) sorgt dafür, dass die IDs (z.B. \"v1RM\") pro Tab einzigartig bleiben\n  ns <- NS(id)\n  \n  sidebarLayout(\n    sidebarPanel(\n      # Input für den Athletennamen\n      textInput(ns(\"athleteName\"), \"Athlete Name:\", value = \"Test Person\"),\n      \n      # Input for the 1RM velocity\n      numericInput(ns(\"v1RM\"), \"Enter the velocity at 1RM (v1RM) in m/s:\", value = 0.2, min = 0, step = 0.01),\n      \n      # Inputs for Weight (kg) and Velocity (m/s) for up to 10 data points\n      h4(\"Enter Weight and Velocity Data:\"),\n      \n      fluidRow(\n        column(2, h5(\"Set\")),  \n        column(5, h5(\"Weight (kg)\")),\n        column(5, h5(\"Velocity (m/s)\"))\n      ),\n      \n      # Generiere die 10 Eingabezeilen\n      lapply(1:10, function(i) {\n        fluidRow(\n          column(2, h5(i)), \n          column(5, numericInput(ns(paste0(\"weight_\", i)), label = NULL, \n                                 value = c(20, 70, 100, 125, 145, NA, NA, NA, NA, NA)[i], \n                                 min = 0, step = 0.01)),\n          column(5, numericInput(ns(paste0(\"velocity_\", i)), label = NULL, \n                                 value = c(1.5, 1.1, 0.83, 0.59, 0.41, NA, NA, NA, NA, NA)[i], \n                                 min = 0, step = 0.01))\n        )\n      }),\n      \n      actionButton(ns(\"calcButton\"), \"Calculate e1RM\")\n    ),\n    \n    mainPanel(\n      verbatimTextOutput(ns(\"plot_info\")),\n      \n      plotOutput(ns(\"plot\"), height = \"500px\"),\n      br(), hr(),\n      \n      h4(\"Individualized Training Interface\"),\n      fluidRow(\n        column(6, \n               numericInput(ns(\"calc_load\"), \"Enter Training Load (kg)\", value = 120, min = 0, step = 1),\n               sliderInput(ns(\"vd_slider\"), \"Velocity Decrement (%)\", \n                           min = 0, max = 100, value = 20, step = 1)\n        ),\n        column(6,\n               verbatimTextOutput(ns(\"vd_output\")),\n               br(),\n               checkboxInput(ns(\"show_zones\"), HTML(\"Display V<sub>dec<\/sub> Zones\"), value = FALSE),\n               checkboxInput(ns(\"show_individual\"), HTML(\"Display V<sub>dec<\/sub> Slider\"), value = FALSE)\n        )\n      ),\n      \n      hr(),\n      \n      fluidRow(\n        column(6, h4(\"Measured Data\"), tableOutput(ns(\"summaryTable\"))),  \n        column(6, h4(\"Predictions\"), tableOutput(ns(\"percentTable\")))   \n      )\n    )\n  )\n}\n\n# ==============================================================================\n# MODUL SERVER DEFINITION (Die Logik für EINEN Athleten)\n# ==============================================================================\nathleteServer <- function(id) {\n  moduleServer(id, function(input, output, session) {\n    \n    # EventReactive to trigger calculation only after button is pressed\n    calculate <- eventReactive(input$calcButton, {\n      df <- data.frame(Weight = numeric(0), Velocity = numeric(0))\n      \n      # Loop through the inputs\n      for (i in 1:10) {\n        weight <- input[[paste0(\"weight_\", i)]]\n        velocity <- input[[paste0(\"velocity_\", i)]]\n        \n        if (!is.na(weight) && !is.na(velocity)) {\n          df <- rbind(df, data.frame(Weight = weight, Velocity = velocity))\n        }\n      }\n      \n      if (nrow(df) >= 2) {\n        return(df)\n      } else {\n        return(NULL)\n      }\n    })\n    \n    # Regression Logic\n    regression <- reactive({\n      df <- calculate()\n      if (!is.null(df)) {\n        fit <- lm(Velocity ~ Weight, data = df)\n        slope <- coef(fit)[\"Weight\"]\n        intercept <- coef(fit)[\"(Intercept)\"]\n        r_squared <- summary(fit)$r.squared\n        \n        target_v <- if (!is.na(input$v1RM)) input$v1RM else 0\n        max_load <- (target_v - intercept) / slope\n        \n        return(list(\n          slope = slope, \n          intercept = intercept, \n          r_squared = r_squared, \n          r2 = r_squared,        \n          max_load = max_load,   \n          model = fit, \n          df = df\n        ))\n      }\n      return(NULL)\n    })\n    \n    # Plot Info Output\n    output$plot_info <- renderPrint({\n      reg <- regression()\n      req(reg)\n      \n      cat(\n        \"Regression Results:\\n\",\n        \"---------------------------\\n\",\n        \"estimated 1RM:      \", sprintf(\"%.2f\", reg$max_load), \" kg\\n\",\n        \"R²:                 \", sprintf(\"%.3f\", reg$r2), \"\\n\",\n        \"Slope:              \", sprintf(\"%.4f\", reg$slope), \"\\n\",\n        \"v0 (Intercept):     \", sprintf(\"%.2f\", reg$intercept), \" m/s\\n\",\n        sep = \"\"\n      )\n    })\n    \n    # Velocity Decrement Output\n    output$vd_output <- renderPrint({\n      reg <- regression()\n      req(reg)\n      req(input$calc_load) \n      \n      e1RM_val <- (input$v1RM - reg$intercept) / reg$slope\n      start_vel <- reg$intercept + reg$slope * input$calc_load\n      perc_start <- (input$calc_load / e1RM_val) * 100\n      stop_vel <- start_vel * (1 - (input$vd_slider / 100))\n      \n      cat(\n        \"Absolute Load:              \", input$calc_load, \" kg\\n\",\n        \"Relative Load:              \", sprintf(\"%.1f\", perc_start), \" %\\n\",\n        \"Initial Velocity:           \", sprintf(\"%.2f\",start_vel), \" m/s\\n\",\n        \"Terminal Velocity(\", input$vd_slider, \"% loss): \", sprintf(\"%.2f\", stop_vel), \" m/s\",\n        sep = \"\"\n      )\n    })\n    \n    # Plot Logic\n    output$plot <- renderPlot({\n      reg <- regression()\n      \n      if (!is.null(reg) && !is.na(input$v1RM)) {\n        df <- reg$df\n        e1RM <- (input$v1RM - reg$intercept) / reg$slope\n        x_max <- ceiling(e1RM / 10) * 10  \n        \n        plot_title <- \"Load-Velocity Profile\"\n        if (input$athleteName != \"\") {\n          plot_title <- paste0(\"Load-Velocity Profile - \", input$athleteName)\n        }\n        \n        p <- ggplot(df, aes(x = Weight, y = Velocity))\n        \n        # --- ZONES ---\n        if(input$show_zones && !is.na(input$calc_load)){\n          v_start <- reg$intercept + reg$slope * input$calc_load\n          v_bounds <- v_start * (1 - cuts_vdec / 100)\n          \n          rect_data <- data.frame(\n            ymin = v_bounds[-1],             \n            ymax = v_bounds[-length(v_bounds)],  \n            fill = custom_colors              \n          )\n          \n          p <- p + geom_rect(\n            data = rect_data,\n            aes(xmin = -Inf, xmax = Inf, ymin = ymin, ymax = ymax, fill = fill),\n            inherit.aes = FALSE,\n            alpha = 0.5 \n          ) +\n            scale_fill_identity() + \n            geom_hline(yintercept = v_start, linetype = \"solid\", color = \"black\", linewidth = 1) +\n            annotate(\"text\", x = min(df$Weight, na.rm=TRUE), y = v_start, label = paste0(\"Load: \", input$calc_load, \"kg\"), vjust = -0.5, hjust = 0)\n        }\n        \n        # --- INDIVIDUAL SLIDER ---\n        if(input$show_individual && !is.na(input$calc_load)){\n          start_load <- input$calc_load\n          start_vel <- reg$intercept + reg$slope * start_load\n          target_vel <- start_vel * (1 - input$vd_slider / 100)\n          \n          p <- p + \n            annotate(\"point\", x = start_load, y = start_vel, color = \"blue4\", size = 4, shape = 25, fill = \"blue2\") +\n            annotate(\"segment\", x = start_load, xend = start_load, y = start_vel, yend = target_vel,\n                     arrow = arrow(length = unit(0.3, \"cm\")), color = \"blue4\", linewidth = 1) +\n            annotate(\"segment\", x = -Inf, xend = start_load, y = target_vel, yend = target_vel,\n                     linetype = \"dashed\", color = \"blue4\", linewidth = 0.8) +\n            annotate(\"text\", x = start_load, y = (start_vel + target_vel)/2, \n                     label = paste0(\"-\", input$vd_slider, \"%\"), hjust = -0.2, color = \"blue4\", fontface = \"bold\")\n        }\n        \n        # Base Plot\n        p <- p +\n          geom_point(color = \"red\", size = 4) + \n          geom_smooth(method = \"lm\", se = FALSE, formula = y ~ x, color = \"black\", linetype = \"dashed\") + \n          geom_point(aes(x = e1RM, y = input$v1RM), color = \"black\", size = 5, shape = 18) + \n          labs(title = plot_title, \n               x = \"Weight (kg)\", \n               y = \"Velocity (m/s)\") +\n          scale_x_continuous(breaks = seq(min(df$Weight, na.rm = TRUE), x_max, by = 10), \n                             limits = c(min(df$Weight, na.rm = TRUE), x_max)) +\n          scale_y_continuous(breaks = seq(0, max(df$Velocity, na.rm = TRUE)+0.2, by = 0.1)) +\n          theme_classic() +\n          theme(\n            plot.title = element_text(size = 18, face = \"bold\"),\n            axis.title = element_text(face = \"bold.italic\", hjust = 0.9, size = 13),\n            axis.text.x = element_text(size = 14),\n            axis.text.y = element_text(size = 14)\n          ) \n        \n        print(p)\n      }\n    })\n    \n    # Table 1\n    output$summaryTable <- renderTable({\n      reg <- regression()\n      if (!is.null(reg) && !is.na(input$v1RM)) {\n        e1RM <- (input$v1RM - reg$intercept) / reg$slope\n        df <- reg$df\n        df$`% of e1RM` <- round((df$Weight / e1RM) * 100, 2)\n        return(df)\n      } else {\n        return(NULL)\n      }\n    })\n    \n    # Table 2\n    output$percentTable <- renderTable({\n      reg <- regression()\n      if (!is.null(reg) && !is.na(input$v1RM)) {\n        e1RM <- (input$v1RM - reg$intercept) / reg$slope\n        percentages <- c(50, 60, 70, 75, 80, 85, 90, 95)\n        weights <- e1RM * (percentages / 100) \n        velocities <- reg$intercept + reg$slope * weights \n        \n        df_percent <- data.frame(\n          Percent = percentages,\n          Weight = round(weights, 1),\n          Velocity = round(velocities, 2)\n        )\n        return(df_percent)\n      } else {\n        return(NULL)\n      }\n    })\n  })\n}\n\n# ==============================================================================\n# MAIN APP (Zusammensetzen der Module)\n# ==============================================================================\n\nui <- fluidPage(\n  titlePanel(\"1-RM Estimator - Multi Athlete\"),\n  \n  # Hier erstellen wir dynamisch 12 Tabs\n  do.call(tabsetPanel, lapply(1:12, function(i) {\n    tabPanel(\n      title = paste(\"Athlete\", i), \n      # Aufruf der Modul-UI mit eindeutiger ID (z.B. \"athlete_1\")\n      athleteUI(paste0(\"athlete_\", i))\n    )\n  }))\n)\n\nserver <- function(input, output, session) {\n  # Hier rufen wir dynamisch 12 mal die Server-Logik auf\n  lapply(1:12, function(i) {\n    # Aufruf des Modul-Servers mit der gleichen ID wie in der UI\n    athleteServer(paste0(\"athlete_\", i))\n  })\n}\n\nshinyApp(ui, server)","type":"text"}]
